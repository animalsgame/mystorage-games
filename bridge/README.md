# Настройка серверной части
### Хранилище использует бд MySQL и PDO в php, для безопасной работы с базой данных  
Загрузите файлы `mystorage.js` и `mystorage.php` на свой хостинг / сервер, они уже готовы к работе  
(загружать желательно где index.html файл игры).  
Откройте файл `storage.php` в своём редакторе кода, и настройте его (если нужно).
```php
$cfg = ...
```
`dbTable` - имя таблицы в бд, по умолчанию `mystorage`, такая таблица будет создана автоматически в вашей бд.  
`maxCreateVars` - максимальное кол-во переменных для одного игрока.  
`maxVarNameSize` - максимальный размер имени переменной.  
`executeLimit` - сколько методов api может обрабатываться за один запрос к серверу через метод `execute`.  
### Настройка базы данных
```php
$cfg['db'] = array(..., 'dbname' => 'main', 'user' => 'root', 'pass' => '');
```
Вам скорее всего понадобятся только эти данные для соединения с бд  
`dbname` - имя вашей базы данных  
`user` - имя пользователя  
`pass` - пароль  
### Добавление игры
Есть два префикса соц сетей  
`vk` - вконтакте  
`ok` - одноклассники  
Чтобы добавить игру, нужно указать префикс соц сети и id игры из настроек игры, во второй аргумент передайте именно защищённый ключ из настроек игры (Разработка -> Ключи доступа)  
```php
$storage->addApp('vk000', 'защищённый_ключ');
```
#### Вы можете добавить и несколько игр, и даже использовать отдельную бд для всех игр с единым хранилищем!
Ещё можно указать админов, чтобы был доступ к методам api которые начинаются с `admin.` нужно указать префикс соц сети и id страницы
```php
$storage->addAdmin('vk000');
```
Важно всё это указать до вызова
```php
$storage->run();
```
Осталось сохранить файл, и загрузить тоже на свой хостинг / сервер.
# Настройка клиентской части (игры)
#### Эти методы vk bridge перехватываются https://dev.vk.com/ru/bridge/overview#Хранилище%20VK%20Storage и функции `subscribe` и `unsubscribe` для подписки на события
Подключите скрипт в index.html игры
```html
<script src="mystorage.js"></script>
```
Затем добавьте js код, желательно до отправки события `VKWebAppInit`  
В свойство `bridge` необходимо передать объект vk bridge, обычно vkBridge, но если у вас vk bridge упакован в скрипт игры и недоступен через `window`, тогда нужно передать нужный объект, не забудьте открыть консоль в браузере, там можно увидеть ошибки и информацию.
Как только вы передали объект в свойство bridge, вы соединили уже vk storage с собственным хранилищем, и уже возможен перенос данных!
```js
var mystorage = new MyStorage({bridge:vkBridge, queue:1, install:1, migrate:1});
```
В объект можно передавать ещё эти свойства (1 - вкл, 0 - откл) для быстрой работы уже всё сделано!  
`queue` - включает очередь, чтобы можно было вызывать хоть 20 методов api подряд, но отправится только один запрос к серверу, и последовательность будет соблюдаться, api ответит как надо!  
`install` - чтобы запустить установку, после установки это свойство нужно удалить (лишний запрос не нужен).  
`migrate` - самое волшебное, перенос данных из vk storage в ваше собственное хранилище, если вы не используете хранилище вк, можно удалить это свойство.
# Перенос данных из хранилища vk
Если вы включили `migrate` и когда игрок входит в игру, отправляется запрос к api вашего хранилища, а вызовы vk bridge которые связаны с хранилищем (помещаются в очередь) чтобы начать процесс переноса данных, таким образом игра не поломается, и всё сохранится корректно, код игры трогать не надо, как и убирать запросы vk bridge, ничего не меняется в коде, и больше хранилище vk не используется.  
А чтобы проверить был ли перенос данных или нет, за это отвечает таблица в бд с именем `_migrate` если оттуда удалить запись, то опять будет перенос из хранилища vk.  
И решается сразу несколько проблем хранилища vk, например размер значения переменной, в вашем хранилище размер ограничен бд, используется `TEXT` а его размер 65535 байт, вместо 4096 символов которое предоставляет vk.
# API хранилища
Для обращения к хранилищу есть функция `api` она возвращает Promise, ничем не отличается от vkBridge.send()
```js
mystorage.api('метод', {})
```
#### Доступные методы api
Параметры и результат совпадают с документацией https://dev.vk.com/ru/method/storage но есть новые методы. 
`storage.clear` - удаление всех переменных игрока, моментальный сброс прогресса.  
`storage.setAll` - установка сразу нескольких переменных (хоть 100 за один запрос), передаётся массив с переменными, результат массив со статусом каждой переменной, 1 - сохранение успешно, 0 - ошибка.
```js
var arr = [{key:'test1', value:'value1'}, {key:'test2', value:'value2'}, ...];
mystorage.api('storage.setAll', {data:arr});
```
`execute` - вызов нескольких методов api, используется как раз по умолчанию, если включена очередь `queue`, передаётся массив в котором находится объект со свойством method, и другие свойства, как обычно, результат это массив, сколько передано методов, столько и элементов будет в массиве.  
Важно помнить что catch не сработает если один из методов вернул ошибку, вместо этого можно проверить, если у объекта есть свойство `error` значит произошла ошибка.
```js
var methods = [{method:'method1'}, {method:'method2', prop1:'test'}, ...];
mystorage.api('execute', {code:methods});
```
`admin.storageGetUsers` - список id игроков которые использовали хранилище, другими словами это как регистрация, получив эти данные, уже можно отправку уведомлений делать, ведь уже будет список id игроков (что и нужно для соц сети), результат массив c id игроков.  
#### Методы которые начинаются с `admin.` доступны только админам, конечно же вы можете создавать собственные методы!
# Добавление собственных методов api
#### Если вы думали что хранилище больше ничего не может, может!  
#### Это не только хранилище, а готовый api для игр, с созданием своих функций, с авторизацией через соц сети, создадим новый метод api!
Откройте `storage.php` создадим метод `my.time` которое вернёт текущее время сервера, функции можно размещать наверху, так удобней, либо в отдельном файле php, важно что добавлять метод надо до вызова `run` функции, как было написано в начале.  
```php
function myMethodTime($my){
return time();
}

// а это добавить до вызова run
$storage->addMethod('my.time', 'myMethodTime');
```
И осталось вызвать метод api из игры
```js
mystorage.api('my.time').then(value => console.log('время сервера', value));
```
В каждую функцию php передаётся переменная `$my`, она же и есть хранилище (`$storage`), есть ещё такие свойства  
`$my->user` - данные игрока, то что возвращает авторизация  
`$my->data` - все данные из post запроса  
# Прочее
Такое вот хранилище получилось за 2 дня :)
