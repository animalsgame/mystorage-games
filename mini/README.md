# Настройка серверной части
### Хранилище использует бд MySQL и PDO в php, для безопасной работы с базой данных  
Загрузите файлы `mystorage.js` и `mystorage.php` на свой хостинг / сервер, они уже готовы к работе  
(загружать желательно где index.html файл игры).  
Откройте файл `storage.php` в своём редакторе кода, и настройте его.  
```php
$cfg = ...
```
`dbTable` - имя таблицы в бд, по умолчанию `mystorage`, такая таблица будет создана автоматически в вашей бд.  
`maxCreateVars` - максимальное кол-во переменных для одного игрока.  
`maxVarNameSize` - максимальный размер имени переменной.  
`executeLimit` - сколько методов api может обрабатываться за один запрос к серверу.  
### Настройка базы данных
```php
$cfg['db'] = array(..., 'dbname' => 'main', 'user' => 'root', 'pass' => '');
```
Вам скорее всего понадобятся только эти данные для соединения с бд  
`dbname` - имя вашей базы данных  
`user` - имя пользователя  
`pass` - пароль  
### Добавление игры
Есть два префикса соц сетей  
`vk` - вконтакте  
`ok` - одноклассники  
Чтобы добавить игру, нужно указать префикс соц сети и id игры из настроек игры, во второй аргумент передайте именно защищённый ключ из настроек игры (Разработка -> Ключи доступа)  
```php
$storage->addApp('vk000', 'защищённый_ключ');
```
#### Вы можете добавить и несколько игр, и даже использовать отдельную бд для всех игр с единым хранилищем!
Ещё можно указать админов, чтобы был доступ к методам api которые начинаются с `admin.` нужно указать префикс соц сети и id страницы
```php
$storage->addAdmin('vk000');
```
Важно всё это указать до вызова
```php
$storage->run();
```
Осталось сохранить файл, и загрузить тоже на свой хостинг / сервер.
# Настройка клиентской части (игры)
Подключите скрипт в index.html игры
```html
<script src="mystorage.js"></script>
```
Затем добавьте js код  
```js
var mystorage = new MyStorage({install:1});
```
В объект можно передавать ещё эти свойства (1 - вкл, 0 - откл)  
`install` - чтобы запустить установку, после установки это свойство можно удалить.  
# API
Для обращения к хранилищу есть функция `api` она возвращает Promise
```js
mystorage.api('метод', {})
```
#### Доступные методы api
Параметры и результат совпадают с api vk https://dev.vk.com/ru/method/storage но есть ещё  
`storage.clear` - удаление всех переменных игрока, моментальный сброс прогресса.  
`admin.storageGetUsers` - список id игроков которые использовали хранилище, другими словами это как регистрация, получив эти данные, уже можно отправку уведомлений делать, ведь уже будет список id игроков (что и нужно для соц сети), результат массив c id игроков.  
#### Методы которые начинаются с `admin.` доступны только админам, конечно же вы можете создавать собственные методы!
# Добавление собственных методов api
#### Это не только хранилище, а готовый api для игр, с созданием своих функций, с авторизацией через соц сети, создадим новый метод api!
Откройте `storage.php` создадим метод `my.time` который вернёт текущее время сервера, и преобразуем его в объект Date, функции можно размещать наверху, так удобней, либо в отдельном файле php, важно что добавлять метод надо до вызова `run` функции, как было написано в начале.  
```php
function myMethodTime($my){
return time();
}

// а это добавить до вызова run
$storage->addMethod('my.time', 'myMethodTime');
```
И осталось вызвать метод api из игры
```js
mystorage.api('my.time').then(value => console.log('дата', new Date(value * 1000)));
```
В каждую функцию php передаётся переменная `$my`, она же и есть хранилище (`$storage`), есть ещё такие свойства  
`$my->user` - данные игрока, то что возвращает авторизация  
`$my->data` - все данные из post запроса  
### Ещё можно вызывать функции js через php
Создадим метод `my.magic` в коде php есть функция `$my->call()` в первый аргумент передаётся сама функция js, а дальше уже необходимые данные, можно передавать и объекты, массивы.  
```php
function myMagic($my){
$data = $my->data;
$my->call($data['mycb'], 'привет');
$my->call($data['arr'][3], 'гав', 'мяу', mt_rand(0, 1) == 1 ? 'курица' : 'яйцо');
return time();
}

$storage->addMethod('my.magic', 'myMagic');
```
Код js
```js
mystorage.api('my.magic', {
mycb:(data) => {
console.log('а вот и', data);
},
arr:
[1, 2, 3, (a, b, c) => {
console.log('Собачка говорит:', a);
console.log('Кошечка говорит:', b);
console.log('Что появилось раньше, яйцо или курица? Ответ:', c, ':)');
}
]
}).then(value => console.log('дата', new Date(value * 1000)));
```
Сначала будет вызвана функция `mycb` а затем в `arr[3]`, и только потом будет вызван then, особенность в том что в Promise можно передать только один аргумент, а в свои функции сколько угодно аргументов, возможности безграничные!
